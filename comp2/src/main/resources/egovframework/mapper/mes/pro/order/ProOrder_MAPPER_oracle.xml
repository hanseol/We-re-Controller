<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mes.pro.order.service.impl.ProOrderMapper">
	

	<resultMap id="proOrder" type="mes.pro.order.service.ProOrderVO">
		<result property="proOrderCode" column="PRO_ORDER_CODE" />
		<result property="proOrderGubun" column="PRO_ORDER_GUBUN" />
		<result property="proOrderQty" column="PRO_ORDER_QTY" />
		<result property="proOrderRank" column="PRO_ORDER_RANK" />
		<result property="proOrderDate" column="PRO_ORDER_DATE" />
	</resultMap>
	
	<insert id="insertProOrder">
		<![CDATA[
			INSERT INTO PRO_ORDER 
				( PRO_ORDER_CODE
				  , PRO_ORDER_GUBUN
				  , PRO_ORDER_QTY
				  , PRO_ORDER_RANK
				  , PRO_ORDER_DATE )
			VALUES ( #{proOrderCode}
				  , #{proOrderGubun}
				  , #{proOrderQty}
				  , #{proOrderRank}
				  , #{proOrderDate} )
		]]>
	</insert>
	
	<update id="updateProOrder">
		<![CDATA[
			UPDATE PRO_ORDER
			SET PRO_ORDER_CODE=#{proOrderCode}
				, PRO_ORDER_GUBUN=#{proOrderGubun}
				, PRO_ORDER_QTY=#{proOrderQty}
				, PRO_ORDER_RANK=#{proOrderRank}
				, PRO_ORDER_DATE=#{proOrderDate}
						WHERE PRO_ORDER_CODE=#{proOrderCode}
				]]>
	</update>
	
	<delete id="deleteProOrder">
		<![CDATA[
			DELETE FROM PRO_ORDER 
						WHERE PRO_ORDER_CODE=#{proOrderCode}
				]]>
	</delete>
	
	<select id="selectProOrder" resultMap="proOrder">
		<![CDATA[
			SELECT
				PRO_ORDER_CODE
				, PRO_ORDER_GUBUN
				, PRO_ORDER_QTY
				, PRO_ORDER_RANK
				, PRO_ORDER_DATE
			FROM PRO_ORDER
						WHERE PRO_ORDER_CODE=#{proOrderCode}
				]]>
	</select>
	
	
	
	<!-- 2번째 그리드의 제품BOM 정보 -->
	<select id="selectmatBomList" parameterType="mes.pro.order.service.ProOrderVO" resultType="egovMap">
		SELECT b.com_product_code
		     , p.com_product_name
		     , b.com_material_code
		     , m.com_material_name
		     , b.com_process_code
		FROM  com_bom b
		    , com_product p
		    , com_material m
		WHERE  b.com_product_code = p.com_product_code 
		   AND b.com_material_code = m.com_material_code
		   AND b.com_product_code = #{comProductCode}
		ORDER BY b.com_material_code
	</select>
	
	
	
	<!-- 생산지시: 생산지시관리에서 입력한 지시 조회(모달) -->
	<select id="selectOrderList" parameterType="mes.pro.order.service.ProOrderVO" resultType="egovMap">
		SELECT pro_order_code
		     , TO_CHAR(pro_order_date, 'yyyy-MM-dd') as pro_order_date
		     , pro_order_gubun
		FROM pro_order
		WHERE 1=1
			<if test="(startDate != null and startDate != '') and (endDate != null and endDate != '')" > AND
				pro_order_date BETWEEN #{startDate} AND #{endDate} 
			</if>	
	</select>
	
	<!-- 생산지시: 생산계획에 작성된 제품 조회(모달) -->	
	<select id="selectPlanProductList" parameterType="mes.pro.order.service.ProOrderVO" resultType="egovMap">
		SELECT	   pd.pro_plan_detail_code
			     , pd.erp_product_code
			     , pd.erp_product_name
			     , pd.erp_order_code
			     , pd.erp_product_deadline
			     , pd.erp_order_qty
			     , m.mac_hour_qty
			     , (m.mac_hour_qty*24) as pro_order_day_qty
		FROM 	  pro_plan_detail pd
		   		, mac m 
		WHERE 	  pd.erp_product_code = m.com_product_code
			<if test="erpProductCode != null and erpProductCode != ''"> AND
				pd.erp_product_code LIKE '%' || #{erpProductCode} || '%'
			</if>
			<if test="erpProductName != null and erpProductName != ''"> AND
				pd.erp_product_name LIKE '%' || #{erpProductName} || '%'
			</if>
		ORDER BY  pd.pro_plan_detail_code
	</select>
	
	<!-- proForm 전체조회 -->
	<select id="selectOrderForm" resultType="egovMap">
		SELECT * FROM (
			SELECT A.*, ROWNUM RNUM FROM (
						SELECT     od.erp_product_code
						         , od.erp_product_name
						         , om.pro_order_gubun
						         , p.erp_order_code
						         , TO_CHAR(od.erp_product_deadline, 'yyyy/MM/dd') as erp_product_deadline
						         , p.erp_order_qty
						         , od.pro_order_qty
						         , m.mac_hour_qty
						         , od.pro_order_day_qty
						         , od.pro_order_expect_qty
						         , TO_CHAR(od.pro_work_date, 'yyyy-MM-dd') as pro_work_date
						         , od.pro_order_seq
						         , od.pro_order_code
						         , om.pro_order_date
						FROM     pro_order_detail od
						       , pro_order om
						       , pro_plan_detail p
						       , mac m     
						WHERE  od.pro_order_code = om.pro_order_code
						  AND  od.pro_plan_detail_code = p.pro_plan_detail_code
						  AND  od.erp_product_code = m.com_product_code							  
							<if test="proOrderDate != null and proOrderDate != ''"> AND
								om.pro_order_date LIKE '%' || TO_DATE(#{proOrderDate}) || '%'
							</if>
							<if test="proOrderCode != null and proOrderCode != ''"> AND
								od.pro_order_code LIKE '%' || #{proOrderCode} || '%'
							</if>
						ORDER BY 
							od.pro_plan_detail_code DESC
				<![CDATA[					
			) A WHERE ROWNUM <= #{lastIndex}
		)WHERE RNUM >= #{firstIndex}
		]]>
	</select>

	
	
	<!-- prodView 전체조회 -->
	<select id="selectProOrderList" parameterType="mes.pro.order.service.ProOrderVO" resultType="egovMap">
		SELECT * FROM (
			SELECT A.*, ROWNUM RNUM FROM (
						SELECT TO_CHAR(d.pro_work_date, 'yyyy/MM/dd') as pro_work_date
								     , d.pro_order_code 
								     , d.erp_customer_code
								     , d.erp_product_code
								     , d.erp_product_name
								     , p.erp_order_code
								     , TO_CHAR(d.erp_product_deadline, 'yyyy/MM/dd') as erp_product_deadline
								     , p.erp_order_qty
								     , d.pro_order_qty
								     , m.pro_order_gubun
								     , l.pro_material_lot 
								     , d.pro_order_seq
								     , d.pro_process_lot_no
								     , TO_CHAR(m.pro_order_date, 'yyyy/MM/dd') as pro_order_date
								FROM pro_order_detail d
								   , pro_order m
								   , pro_plan_detail p
								   , pro_material_lot l
								WHERE d.pro_order_code = m.pro_order_code
								  AND d.pro_plan_detail_code = p.pro_plan_detail_code
								  AND d.pro_order_detail_code = l.pro_order_detail_code								  
								<if test="(startDate != null and startDate != '') and (endDate != null and endDate != '')" >
									<if test="searchCondition == 1"> AND
										d.pro_work_date BETWEEN #{startDate} AND #{endDate} 
									</if>
									<if test="searchCondition == 2"> AND
										d.erp_product_deadline BETWEEN #{startDate} AND #{endDate} 
									</if>
								</if>
								<if test="erpProductCode != null and erpProductCode != ''"> AND
									d.erp_product_code LIKE '%' || #{erpProductCode} || '%'
								</if>
								<if test="erpCustomerCode != null and erpCustomerCode != ''"> AND
									d.erp_customer_code LIKE '%' || #{erpCustomerCode} || '%'
								</if>
							ORDER BY 
								m.PRO_ORDER_CODE DESC
				
				<![CDATA[					
			) A WHERE ROWNUM <= #{lastIndex}
		)WHERE RNUM >= #{firstIndex}
		]]>
	</select>	
	<select id="selectProOrderListTotCnt" parameterType="mes.pro.order.service.ProOrderVO" resultType="int">
			SELECT COUNT(*) totcnt
				FROM pro_order_detail o
						   , pro_plan_detail p
						   , mac m
						WHERE p.erp_product_code = o.erp_product_code
						  AND m.com_product_code = o.erp_product_code
					  <!-- AND 1=1 -->
			<if test="searchKeyword != null and searchKeyword != ''">
				<if test="searchCondition == 0">AND
					PRO_ORDER_CODE = #{searchKeyword}
				</if>
				<if test="searchCondition == 1">AND
					PRO_ORDER_GUBUN LIKE '%' || #{searchKeyword} || '%'
				</if>
			</if>
	</select>

</mapper>
