<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mes.pro.proc.service.impl.ProProcessMapper">
	

	<resultMap id="proProcess" type="mes.pro.proc.service.ProProcessVO">
		<result property="comProcessCode" column="COM_PROCESS_CODE" />
		<result property="proOrderDetailCode" column="PRO_ORDER_DETAIL_CODE" />
		<result property="comProductFCode" column="COM_PRODUCT_F_CODE" />
		<result property="proProcessFQty" column="PRO_PROCESS_F_QTY" />
		<result property="macLineNo" column="MAC_LINE_NO" />
		<result property="proProcessStartTime" column="PRO_PROCESS_START_TIME" />
		<result property="proProcessEndTime" column="PRO_PROCESS_END_TIME" />
		<result property="erpEmployeeId" column="ERP_EMPLOYEE_ID" />
		<result property="macCode" column="MAC_CODE" />
		<result property="proProcessLotNo" column="PRO_PROCESS_LOT_NO" />
		<result property="proProcessQuantity" column="PRO_PROCESS_QUANTITY" />
	</resultMap>
	
	<insert id="insertProProcess">
		<![CDATA[
			INSERT INTO PRO_PROCESS 
				( COM_PROCESS_CODE
				  , PRO_ORDER_DETAIL_CODE
				  , COM_PRODUCT_F_CODE
				  , PRO_PROCESS_F_QTY
				  , MAC_LINE_NO
				  , PRO_PROCESS_START_TIME
				  , PRO_PROCESS_END_TIME
				  , ERP_EMPLOYEE_ID
				  , MAC_CODE
				  , PRO_PROCESS_LOT_NO
				  , PRO_PROCESS_QUANTITY )
			VALUES ( #{comProcessCode}
				  , #{proOrderDetailCode}
				  , #{comProductFCode}
				  , #{proProcessFQty}
				  , #{macLineNo}
				  , #{proProcessStartTime}
				  , #{proProcessEndTime}
				  , #{erpEmployeeId}
				  , #{macCode}
				  , #{proProcessLotNo}
				  , #{proProcessQuantity} )
		]]>
	</insert>
	
	<update id="updateProProcess">
		<![CDATA[
			UPDATE PRO_PROCESS
			SET COM_PROCESS_CODE=#{comProcessCode}
				, PRO_ORDER_DETAIL_CODE=#{proOrderDetailCode}
				, COM_PRODUCT_F_CODE=#{comProductFCode}
				, PRO_PROCESS_F_QTY=#{proProcessFQty}
				, MAC_LINE_NO=#{macLineNo}
				, PRO_PROCESS_START_TIME=#{proProcessStartTime}
				, PRO_PROCESS_END_TIME=#{proProcessEndTime}
				, ERP_EMPLOYEE_ID=#{erpEmployeeId}
				, MAC_CODE=#{macCode}
				, PRO_PROCESS_LOT_NO=#{proProcessLotNo}
				, PRO_PROCESS_QUANTITY=#{proProcessQuantity}
						WHERE COM_PROCESS_CODE=#{comProcessCode}
								AND PRO_ORDER_DETAIL_CODE=#{proOrderDetailCode}
				]]>
	</update>
	
	<delete id="deleteProProcess">
		<![CDATA[
			DELETE FROM PRO_PROCESS 
						WHERE COM_PROCESS_CODE=#{comProcessCode}
								AND PRO_ORDER_DETAIL_CODE=#{proOrderDetailCode}
				]]>
	</delete>
	
	<select id="selectProProcess" resultMap="proProcess">
		<![CDATA[
			SELECT
				COM_PROCESS_CODE
				, PRO_ORDER_DETAIL_CODE
				, COM_PRODUCT_F_CODE
				, PRO_PROCESS_F_QTY
				, MAC_LINE_NO
				, PRO_PROCESS_START_TIME
				, PRO_PROCESS_END_TIME
				, ERP_EMPLOYEE_ID
				, MAC_CODE
				, PRO_PROCESS_LOT_NO
				, PRO_PROCESS_QUANTITY
			FROM PRO_PROCESS
						WHERE COM_PROCESS_CODE=#{comProcessCode}
								AND PRO_ORDER_DETAIL_CODE=#{proOrderDetailCode}
				]]>
	</select>
	
	<select id="selectProProcessList" parameterType="mes.pro.proc.service.ProProcessVO" resultType="egovMap">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				SELECT
								COM_PROCESS_CODE
								, PRO_ORDER_DETAIL_CODE
								, COM_PRODUCT_F_CODE
								, PRO_PROCESS_F_QTY
								, MAC_LINE_NO
								, PRO_PROCESS_START_TIME
								, PRO_PROCESS_END_TIME
								, ERP_EMPLOYEE_ID
								, MAC_CODE
								, PRO_PROCESS_LOT_NO
								, PRO_PROCESS_QUANTITY
						FROM PRO_PROCESS
				WHERE 1=1
				<if test="searchKeyword != null and searchKeyword != ''">
					<if test="searchCondition == 0">AND
						COM_PROCESS_CODE = #{searchKeyword}
					</if>
					<if test="searchCondition == 1">AND
						PRO_ORDER_DETAIL_CODE LIKE '%' || #{searchKeyword} || '%'
					</if>
				</if>
					ORDER BY 
						COM_PROCESS_CODE DESC
							, PRO_ORDER_DETAIL_CODE DESC
		
		<![CDATA[					
	) A WHERE ROWNUM <= #{lastIndex}
)WHERE RNUM > #{firstIndex}
]]>
	</select>	
	<select id="selectProProcessListTotCnt" parameterType="mes.pro.proc.service.ProProcessVO" resultType="int">
			SELECT COUNT(*) totcnt
			FROM PRO_PROCESS
			WHERE 1=1
			<if test="searchKeyword != null and searchKeyword != ''">
				<if test="searchCondition == 0">AND
					COM_PROCESS_CODE = #{searchKeyword}
				</if>
				<if test="searchCondition == 1">AND
					PRO_ORDER_DETAIL_CODE LIKE '%' || #{searchKeyword} || '%'
				</if>
			</if>
	</select>


	<!-- 김한설 공정흐름관리 -->
	
	<!-- 공정 리스트 조회 -->
	<select id="selectProProcessName" resultType="mes.pro.proc.service.ProProcessVO">
		SELECT COM_CODE_DETAIL_ID AS COM_PROCESS_CODE
				, COM_CODE_DETAIL_NAME AS COM_PROCESS_NAME
		FROM COM_CODE_DETAIL
		WHERE COM_CODE_ID = 'MES007'
	</select>
	
	<!-- 각 공정에서 작업 대기중인 지시 항목 불러오기. (오늘 지시목록 중에 해당공정에서 작업중이거나 작업완료된 지시는 필터링 되어야함.) -->
	<!-- PROCG001:제작, PROCG002:검사, PROCG003:포장 -->
	<select id="selectProOrderDetailCode" parameterType="mes.pro.proc.service.ProProcessVO" resultType="String">
		<if test="comProcessCode == 'PROCG001'">
			SELECT OD.PRO_ORDER_DETAIL_CODE
			FROM PRO_ORDER_DETAIL OD
			WHERE OD.PRO_ORDER_DETAIL_CODE NOT IN (SELECT PRO_ORDER_DETAIL_CODE FROM PRO_PROCESS)
			AND OD.PRO_WORK_DATE = TRUNC(sysdate)
			ORDER BY OD.PRO_ORDER_SEQ
		</if>
		<if test="comProcessCode == 'PROCG002'">
			SELECT OD.PRO_ORDER_DETAIL_CODE
			FROM PRO_ORDER_DETAIL OD, PRO_PROCESS P
			WHERE OD.PRO_ORDER_DETAIL_CODE = P.PRO_ORDER_DETAIL_CODE
			AND P.COM_PROCESS_CODE = 'PROCG001' AND P.PRO_PROCESS_END_TIME IS NOT NULL
			AND P.COM_PROCESS_CODE NOT IN ('PROCG002')
			AND OD.PRO_WORK_DATE = TRUNC(sysdate)
			ORDER BY OD.PRO_ORDER_SEQ
		</if>
		<if test="comProcessCode == 'PROCG003'">
			
		</if>
	</select>
	
	<!-- 선택된 지시에 필요한 자재 LOT 정보를 자재 종류별로 보여준다. -->
	<select id="selectMatrLot" parameterType="mes.pro.proc.service.ProProcessVO" resultType="mes.pro.proc.service.ProProcessVO">
		SELECT MI.COM_MATERIAL_CODE,
      	CM.COM_MATERIAL_NAME, 
     	PML.MAT_LOT_NO, 
      	PML.PRO_ORDER_DETAIL_CODE
		FROM PRO_MATERIAL_LOT PML, MAT_INOUT MI, COM_MATERIAL CM
		WHERE PML.MAT_LOT_NO = MI.MAT_LOT_NO
		AND MI.COM_MATERIAL_CODE = CM.COM_MATERIAL_CODE
		AND PML.PRO_ORDER_DETAIL_CODE = #{proOrderDetailCode}
	</select>
</mapper>
