<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mes.qua.chk.service.impl.QuaChkMapper">


	<!-- 자재입고검사조회 발주리스트  -->
	<select id="selectQuaChkList" parameterType="mes.qua.chk.service.QuaChkVO" resultType="egovMap">
		SELECT *
		FROM   (
		              SELECT a.*,
		                     ROWNUM rnum
		              FROM   (
										SELECT  q.erp_material_order_code,
										        q.qua_material_statement,
										        TO_CHAR(q.qua_material_date,'YY/MM/DD')as qua_material_date,
										        q.erp_vendor_code,
										        d.com_code_detail_name,
                            					q.com_material_code,                            
										        c.com_material_name,
										        c.com_material_size,
										        c.com_material_unit,
										        e.erp_material_order_qty,
										        TO_CHAR(e.erp_material_request_date,'YY/MM/DD')as erp_material_request_date,
										        q.qua_material_p_qty,
										        q.qua_material_f_qty,
										        q.qua_material_chk,
										        e.erp_material_unit_price,
										        e.erp_material_order_qty * e.erp_material_unit_price as erp_material_price,
										        TO_CHAR(e.erp_material_order_date,'YY/MM/DD')AS erp_material_order_date,
										        TO_CHAR(q.qua_material_chk_date,'YY/MM/DD')as qua_material_chk_date
										        
										FROM    com_material c,
										        erp_material_order e,
										        qua_material_chk q,
										        com_code_detail d
										        
					                    WHERE   e.com_material_code = q.com_material_code
					                    AND     q.com_material_code = c.com_material_code
					                    AND     q.erp_vendor_code = e.erp_vendor_code
					                    AND     d.com_code_detail_id = q.erp_vendor_code
					                    AND     q.erp_material_order_code = e.erp_material_order_code
					                    AND		q.qua_material_chk = '0'
					                   	<if test="erpVendorCode != null and erpVendorCode != ''">
		                                AND
							        	q.erp_vendor_code LIKE '%' || #{erpVendorCode} || '%'
		                              	</if>
		                              	<if test="comMaterialCode != null and comMaterialCode != ''">
		                              	AND
							        	q.com_material_code LIKE '%' || #{comMaterialCode} || '%'
		                              	</if>
		                              	<if test="quaMaterialDate != null and quaMaterialDate != ''">
		                              	AND
							        	q.qua_material_date BETWEEN #{quaMaterialDate} AND #{quaMaterialEndDate}
		                              	</if>
		                              ORDER BY q.qua_material_date <![CDATA[ ) a
		              WHERE  ROWNUM <= #{lastIndex} )
		WHERE  rnum >= #{firstIndex}
		]]>	
	</select>
	
	
	<!-- 합격 리스트 조회 -->
	<select id="selectQuaChkPassList" parameterType="mes.qua.chk.service.QuaChkVO" resultType="egovMap">
				SELECT *
		FROM   (
		              SELECT a.*,
		                     ROWNUM rnum
		              FROM   (
										SELECT  q.erp_material_order_code,
										        q.qua_material_statement,
										        TO_CHAR(q.qua_material_date,'YY/MM/DD')as qua_material_date,
										        q.erp_vendor_code,
										        d.com_code_detail_name,
                            					q.com_material_code,
										        c.com_material_name,
										        c.com_material_size,
										        c.com_material_unit,
										        e.erp_material_order_qty,
										        TO_CHAR(e.erp_material_request_date,'YY/MM/DD')as erp_material_request_date,
										        q.qua_material_p_qty,
										        q.qua_material_f_qty,
										        q.qua_material_chk,
										        e.erp_material_unit_price,
										        e.erp_material_order_qty * e.erp_material_unit_price as erp_material_price,
										        TO_CHAR(e.erp_material_order_date,'YY/MM/DD')AS erp_material_order_date,
										        TO_CHAR(q.qua_material_chk_date,'YY/MM/DD')as qua_material_chk_date
										        
										FROM    com_material c,
										        erp_material_order e,
										        qua_material_chk q,
										        com_code_detail d
										        
					                    WHERE   e.com_material_code = q.com_material_code
					                    AND     q.com_material_code = c.com_material_code
					                    AND     q.erp_vendor_code = e.erp_vendor_code
					                    AND     d.com_code_detail_id = q.erp_vendor_code
					                    AND     q.erp_material_order_code = e.erp_material_order_code
					                    AND		q.qua_material_chk = '1'
					                   	<if test="erpVendorCode != null and erpVendorCode != ''">
		                                AND
							        	q.erp_vendor_code LIKE '%' || #{erpVendorCode} || '%'
		                              	</if>
		                              	<if test="comMaterialCode != null and comMaterialCode != ''">
		                              	AND
							        	q.com_material_code LIKE '%' || #{comMaterialCode} || '%'
		                              	</if>
		                              	<if test="quaMaterialDate != null and quaMaterialDate != ''">
		                              	AND
							        	q.qua_material_date BETWEEN #{quaMaterialDate} AND #{quaMaterialEndDate}
		                              	</if>
		                              ORDER BY q.qua_material_date <![CDATA[ ) a
		              WHERE  ROWNUM <= #{lastIndex} )
		WHERE  rnum >= #{firstIndex}
		]]>	
	</select>
	
	<!-- 자재불량 모달 리스트 출력 -->
	<select id="searchMatFltyCodeList" parameterType="mes.qua.chk.service.QuaChkVO" resultType="egovMap">
		SELECT *
		FROM   (
		          	SELECT a.*,
		                     ROWNUM rnum
		            FROM   (
		                              SELECT   com_material_f_code,
		                                       com_material_f_name,
		                                       com_material_f_desc
		                              FROM     com_material_f
		                              WHERE	   1=1
					                  <if test="comMaterialFCode != null and comMaterialFCode !=''"> AND
					                     com_material_f_code LIKE '%' || #{comMaterialFCode} || '%'
					                  </if>
					                  <if test="comMaterialFName != null and comMaterialFName !=''">AND
					                     com_material_f_name LIKE '%' || #{comMaterialFName} || '%'
					                  </if>
									  ORDER BY com_material_f_code <![CDATA[ ) A
         			WHERE ROWNUM <= #{lastIndex})
		WHERE RNUM >= #{firstIndex}]]>
	</select>
	<!-- 자재불량 모달 리스트 합격량 불량량 출력 -->
	<select id="searchMatFltyCodeQtyList" parameterType="mes.qua.chk.service.QuaChkVO" resultType="egovMap">
		SELECT *
		FROM   (
		          	SELECT a.*,
		                     ROWNUM rnum
		            FROM   (
		                              SELECT   q.qua_material_statement,
		                              		   q.qua_material_p_qty,
		                              		   q.qua_material_f_qty,
		                              		   e.erp_material_order_qty,
		                              		   e.erp_material_order_code
		                              FROM     qua_material_chk q,
		                              		   erp_material_order e
		                              WHERE	   q.erp_material_order_code = e.erp_material_order_code
					                  <!-- <if test="comMaterialFCode != null and comMaterialFCode !=''"> AND
					                     com_material_f_code LIKE '%' || #{comMaterialFCode} || '%'
					                  </if>
					                  <if test="comMaterialFName != null and comMaterialFName !=''">AND
					                     com_material_f_name LIKE '%' || #{comMaterialFName} || '%'
					                  </if> -->
					                  <if test="erpMaterialOrderCode != null and erpMaterialOrderCode !=''">AND
					                     q.erp_material_order_code LIKE '%' || #{erpMaterialOrderCode} || '%'
					                  </if>
									  ORDER BY qua_material_statement <![CDATA[ ) A
         			WHERE ROWNUM <= #{lastIndex})
		WHERE RNUM >= #{firstIndex}]]>
	</select>
	
	<!-- 자재입고검사 더미데이터 추가(QUA-*** 전표번호) -->
	<insert id="insertQuaChk">
		INSERT INTO qua_material_chk  (qua_material_statement,
									   erp_material_order_code,
									   qua_material_date,
									   erp_vendor_code,
									   com_material_code,
									   qua_material_p_qty,
									   qua_material_f_qty,
									   qua_material_chk)
							VALUES  	(#{quaMaterialStatement},
										#{erpMaterialOrderCode},
										#{quaMaterialDate},
								   		#{erpVendorCode},
								   		#{comMaterialCode},
								   		#{quaMaterialPQty},
								   		#{quaMaterialFQty},
								   		#{quaMaterialChk})
	</insert>
	<!-- 검사 후 전표번호 발급해서 자재입출고로(MATIN-*** 전표번호) 작업중....-->
	<insert id="insertQuaChkMatIn">
		INSERT INTO mat_inout  		  (mat_inout_statement,
									   qua_material_statement,
									   com_material_code,
									   mat_inout_date,
									   mat_inout_gubun,
									   mat_inout_quantity,
									   mat_lot_no,
									   mat_inout_unit_price,
									   mat_inout_price)
							VALUES  	(#{matInoutStatement},
										 #{quaMaterialStatement},
										#{comMaterialCode},
								   		TO_CHAR(SYSDATE, 'YY/MM/DD'),
								   		'INOUT002',
								   		#{quaMaterialPQty},
								   		#{matLotNo},
								   		#{erpMaterialUnitPrice},
								   		(#{quaMaterialPQty}*#{erpMaterialUnitPrice}))
	</insert>
	
	<!-- 자재불량테이블로 불량자료 넘기기 -->
	<insert id="insertMatFlty">
		INSERT INTO qua_material_f		(erp_material_order_code,
										 com_material_f_code,
										 qua_material_f_qty,
										 com_material_code,
										 qua_material_statement)
							VALUES		(#{erpMaterialOrderCode},
										 #{comMaterialFCode},
										 #{quaMaterialFQty},
										 #{comMaterialCode},
										 #{quaMaterialStatement})
							
	</insert>
	
	
	<!-- 자재검사 완료 -->
	<update id="updateQuaChk">
		UPDATE 		qua_material_chk
		
		SET			qua_material_date = #{erpMaterialRequestDate},
					erp_vendor_code = #{erpVendorCode},
					com_material_code = #{comMaterialCode},
					qua_material_p_qty = #{quaMaterialPQty},
					qua_material_f_qty = #{quaMaterialFQty},
					qua_material_chk = #{quaMaterialChk},
					qua_material_chk_date = TO_CHAR(SYSDATE, 'YY/MM/DD'),
					erp_material_order_code = #{erpMaterialOrderCode}
					
		WHERE	qua_material_statement = #{quaMaterialStatement}
	</update>
	
	<!-- 삭제 (QUA-*** 전표번호가 있는 검사완료데이터만 삭제 가능 / 발주목록데이터는 삭제 불가 -->
	<delete id="deleteQuaChk">
		DELETE FROM	qua_material_chk
		WHERE		qua_material_statement = #{quaMaterialStatement}
	</delete>
	
</mapper>
